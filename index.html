<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Haytocen Snake VIP</title>
    <style>
        :root {
            --primary: #f1c40f;
            --bg: #0b0e11;
            --surface: #1c2128;
            --text: #ffffff;
            --text-dim: #8b949e;
            --canvas-bg: #111;
            --accent: #e74c3c;
            --success: #2ecc71;
            --btn-blue: #3498db;
        }

        body { 
            margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; 
            overflow: hidden; touch-action: none; -webkit-user-select: none; user-select: none;
            height: 100dvh;
        }

        #main-wrapper { max-width: 500px; margin: auto; height: 100%; display: flex; flex-direction: column; }

        /* Header */
        .header { 
            background: var(--surface); padding: 0 15px; border-bottom: 2px solid var(--primary); 
            display: flex; justify-content: space-between; align-items: center; 
            height: 50px; flex-shrink: 0; z-index: 10;
        }
        .header-left { display: flex; gap: 15px; align-items: center; font-weight: 900; font-size: 18px; }
        .mute-btn { cursor: pointer; font-size: 20px; padding: 5px; }

        .content-area { flex-grow: 1; position: relative; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; }
        .page-section { display: none; width: 100%; min-height: 100%; flex-direction: column; align-items: center; }

        /* Game Section */
        #game-section { height: 100%; overflow: hidden; justify-content: space-between; padding-bottom: 10px; box-sizing: border-box; }
        .level-info { width: 100%; display: flex; justify-content: space-between; padding: 5px 15px; box-sizing: border-box; background: rgba(0,0,0,0.3); font-size: 12px; font-weight: bold; color: var(--primary); }
        .progress-bar { width: 100%; height: 4px; background: #333; position: relative; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
        
        .canvas-container { flex-grow: 1; width: 100%; display: flex; align-items: center; justify-content: center; position: relative; padding: 10px; box-sizing: border-box; }
        .canvas-wrapper { position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 8px; }
        canvas { display: block; background: var(--canvas-bg); border: 2px solid var(--primary); border-radius: 8px; transition: background 1s; }
        .start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); border-radius: 8px; display: flex; align-items: center; justify-content: center; z-index: 20; flex-direction: column; }
        
        .controls-area { flex-shrink: 0; display: flex; justify-content: center; margin-bottom: 5px; }
        .controls { display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 50px); gap: 6px; }
        .ctrl-btn { width: 100%; height: 100%; background: var(--surface); border: 1px solid #444; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--primary); box-shadow: 0 3px 0 #000; touch-action: manipulation; }
        .ctrl-btn:active { transform: translateY(3px); box-shadow: 0 0 0; background: #2a2f38; }

        /* Wheel Styles */
        .wheel-container { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px; }
        .wheel-outer { position: relative; width: 280px; height: 280px; border-radius: 50%; border: 8px solid var(--surface); overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        /* –°—Ç—Ä–µ–ª–∫–∞ */
        .wheel-pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 30px; height: 40px; background: #e74c3c; clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 25; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        
        #wheel { 
            width: 100%; height: 100%; border-radius: 50%; position: relative;
            transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); 
            /* –¶–≤–µ—Ç–∞ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
            background: conic-gradient(
                #8e44ad 0deg 45deg,   /* 10 HT (Purple) */
                #f1c40f 45deg 90deg,  /* 25 HT (Yellow) */
                #34495e 90deg 135deg, /* VIP (Dark Blue/Grey) */
                #e67e22 135deg 180deg, /* 1 HT (Orange) */
                #34495e 180deg 225deg, /* 0 HT (Dark Blue/Grey) */
                #f1c40f 225deg 270deg, /* Again (Yellow) */
                #34495e 270deg 315deg, /* 1 Star (Dark Blue/Grey) */
                #e67e22 315deg 360deg  /* 5 HT (Orange) */
            );
        }
        .wheel-label { position: absolute; top: 50%; left: 50%; width: 50%; height: 20px; margin-top: -10px; transform-origin: left center; display: flex; align-items: center; justify-content: flex-end; font-weight: 900; font-size: 13px; padding-right: 30px; box-sizing: border-box; color: #fff; text-shadow: 1px 1px 2px #000; }
        
        /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        .l1 { transform: rotate(22.5deg); } /* 10 HT */
        .l2 { transform: rotate(67.5deg); color: #000; text-shadow: none; } /* 25 HT */
        .l3 { transform: rotate(112.5deg); } /* VIP */
        .l4 { transform: rotate(157.5deg); } /* 1 HT */
        .l5 { transform: rotate(202.5deg); } /* 0 HT */
        .l6 { transform: rotate(247.5deg); color: #000; text-shadow: none; } /* Again */
        .l7 { transform: rotate(292.5deg); } /* 1 Star */
        .l8 { transform: rotate(337.5deg); } /* 5 HT */

        .scrollable-content { padding: 15px; width: 100%; box-sizing: border-box; }
        .card { background: var(--surface); padding: 15px; border-radius: 16px; width: 100%; margin-bottom: 12px; border: 1px solid #333; box-sizing: border-box; }
        .btn-main { padding: 12px 25px; border-radius: 10px; border: none; background: var(--primary); font-weight: 900; font-size: 16px; color: #000; cursor: pointer; transition: 0.2s; width: 100%; }
        .btn-main:disabled { background: #555; color: #888; cursor: not-allowed; }
        .btn-buy { padding: 8px 20px; border-radius: 10px; border: none; background: var(--btn-blue); font-weight: 900; font-size: 14px; color: #fff; cursor: pointer; box-shadow: 0 3px 0 #1e5a82; }
        .btn-withdraw { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--success); font-weight: 900; font-size: 16px; color: #000; cursor: pointer; margin-top: 10px; }
        .btn-withdraw:disabled { background: #444; color: #777; cursor: not-allowed; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .nav-bar { background: var(--surface); padding: 5px 0 20px; border-top: 1px solid #333; height: 65px; flex-shrink: 0; display: flex; z-index: 50; }
        .nav-item { flex: 1; text-align: center; color: var(--text-dim); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .nav-item span { font-size: 20px; margin-bottom: 2px; }
        .nav-item div { font-size: 9px; font-weight: 800; text-transform: uppercase; }
        .nav-item.active { color: var(--primary); transform: scale(1.1); transition: transform 0.2s; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .exchange-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin: 10px 0; font-weight: bold; font-size: 18px; }

        /* Particles canvas for effects */
        #effectsCanvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <canvas id="effectsCanvas"></canvas>
    
    <div id="main-wrapper">
        <div class="header">
            <div class="header-left">
                <span>üêç <span id="score">0</span></span>
                <span style="font-size: 12px; margin-left: 10px; color: #aaa;">BEST: <span id="high-score">0</span></span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="mute-btn" id="muteBtn" onclick="toggleMute()">üîä</span>
                <div style="text-align: right; line-height: 1.2;">
                    <span style="font-size: 9px; opacity: 0.7;">‘≤‘±‘º‘±’Ü’ç</span><br>
                    <span style="color: var(--primary); font-weight: 900; font-size: 14px;"><span id="balance">0</span> HT</span>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div id="game-section" class="page-section" style="display: flex;">
                <div class="level-info">
                    <span>LEVEL <span id="level-display">1</span></span>
                    <span><span id="level-progress-text">0</span> / 40</span>
                </div>
                <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper" id="canvasWrapper">
                        <canvas id="gameCanvas"></canvas>
                        <div id="startOverlay" class="start-overlay">
                            <h2 style="margin: 0 0 10px 0; color: var(--primary);">LEVEL <span id="overlay-level">1</span></h2>
                            <button id="startBtn" class="btn-main" onclick="startGame()">‘Ω‘±’Ç‘±‘º</button>
                        </div>
                    </div>
                </div>
                <div class="controls-area">
                    <div class="controls">
                        <div class="ctrl-btn" style="grid-column:2" onpointerdown="handleControl(event, 'UP')">‚ñ≤</div>
                        <div class="ctrl-btn" style="grid-column:1; grid-row:2" onpointerdown="handleControl(event, 'LEFT')">‚óÄ</div>
                        <div class="ctrl-btn" style="grid-column:3; grid-row:2" onpointerdown="handleControl(event, 'RIGHT')">‚ñ∂</div>
                        <div class="ctrl-btn" style="grid-column:2; grid-row:2" onpointerdown="handleControl(event, 'DOWN')">‚ñº</div>
                    </div>
                </div>
            </div>

            <div id="wheel-section" class="page-section scrollable-content">
                <div class="wheel-container">
                    <h2 style="color: var(--primary); margin: 0;">‘±’∂’´’æ (4 ‘∫’°’¥)</h2>
                    <div class="wheel-outer">
                        <div class="wheel-pointer"></div>
                        <div id="wheel">
                            <div class="wheel-label l1">10 HT</div>
                            <div class="wheel-label l2">25 HT</div>
                            <div class="wheel-label l3">VIP 1’ï÷Ä</div>
                            <div class="wheel-label l4">1 HT</div>
                            <div class="wheel-label l5">0 HT</div>
                            <div class="wheel-label l6">‘ø’ê‘ø‘ª’Ü</div>
                            <div class="wheel-label l7">1 ‚≠ê</div>
                            <div class="wheel-label l8">5 HT</div>
                        </div>
                    </div>
                    <div style="width: 100%; text-align: center; margin-top: 15px;">
                        <button id="spinBtn" class="btn-main" style="width: 180px;" onclick="spinWheel()">’ä’è’è‘µ‘º</button>
                        <div id="wheel-timer" style="margin-top: 10px; font-weight: bold; color: #e74c3c; display: none;">03:59:59</div>
                    </div>
                    <p id="wheel-msg" style="color: var(--primary); font-weight: bold; min-height: 20px; text-align: center; margin-top: 10px;"></p>
                </div>
            </div>

            <div id="shop-section" class="page-section scrollable-content">
                <h2 style="text-align: center; color: var(--primary); margin-top:0;">üíé VIP ‘Ω‘±’Ü’à’í‘π</h2>
                <div class="card">
                    <ul style="padding-left: 20px; margin:0; font-size: 13px; color: #ddd;">
                        <li><b>2x ‘≤’∏’∂’∏÷Ç’Ω</b> ’≠’°’≤’∏÷Ç’¥</li>
                        <li><b>2x ’Ä’°’≤’©’°’∂’°’Ø</b> ‘±’∂’´’æ’∏÷Ç’¥</li>
                        <li>üí∞ ’Ä’°’∂’¥’°’∂ ’¨’´’¥’´’ø <b>2500 HT</b></li>
                    </ul>
                </div>
                <div class="card">
                    <div class="shop-item"><div><b>5 ’ï’ê</b></div><button class="btn-buy" onclick="mockPurchase()">20 ‚≠ê</button></div>
                    <div class="shop-item"><div style="color: var(--primary);"><b>15 ’ï’ê</b></div><button class="btn-buy" onclick="mockPurchase()">150 ‚≠ê</button></div>
                    <div class="shop-item"><div style="color: #e74c3c;"><b>30 ’ï’ê</b></div><button class="btn-buy" onclick="mockPurchase()">500 ‚≠ê</button></div>
                </div>
            </div>

            <div id="bonus-section" class="page-section scrollable-content">
                <div class="card" style="text-align: center; margin-top: 20px;">
                    <h2>’ï÷Ä’°’Ø’°’∂ ’¢’∏’∂’∏÷Ç’Ω</h2>
                    <div style="font-size: 80px; margin: 20px;">üéÅ</div>
                    <button id="claimBtn" class="btn-main" onclick="claimDailyBonus()">‘≤‘±’ë‘µ‘º</button>
                    <p id="bonus-msg" style="margin-top: 15px; font-size: 14px; color: #888;"></p>
                </div>
            </div>

            <div id="profile-section" class="page-section scrollable-content">
                <div class="card" style="text-align: center;">
                    <p style="margin:0; font-size: 14px;">’Å’•÷Ä ’∞’°’∑’´’æ’®:</p>
                    <h1 style="color: var(--primary); font-size: 32px; margin: 5px 0;"><span id="profile-balance">0</span> HT</h1>
                    <p id="vip-status-profile" style="font-size: 14px; margin: 5px 0;"></p>
                </div>
                <div class="card" style="border: 2px solid var(--success);">
                    <h3 style="margin: 0; color: var(--success);">üí∏ ’ì’∏’≠’°’∂’°’Ø’∏÷Ç’¥</h3>
                    <div class="exchange-row">
                        <span style="color: var(--primary);"><span id="withdraw-limit-text">5000</span> HT</span>
                        <span>‚û°Ô∏è</span>
                        <span style="color: var(--success);">1 $</span>
                    </div>
                    <p id="withdraw-status" style="font-size: 12px; text-align: center; margin: 5px 0;">‘≤’•’º’∂’∏÷Ç’¥...</p>
                    <button id="withdrawBtn" class="btn-withdraw" onclick="withdrawMoney()">’ì’à‘Ω‘±’Ü‘±‘ø‘µ‘º</button>
                </div>
                <div class="card" style="border-left: 4px solid #2481cc;">
                    <h3>ü§ù ’å’•÷Ü’•÷Ä’°’¨</h3>
                    <p style="font-size: 13px;">‘∏’∂’Ø’•÷Ä’∏’ª ’∞’°’¥’°÷Ä: <span style="color: var(--primary);">+15 HT</span></p>
                    <button class="btn-main" style="width:100%; background:#2481cc; color:#fff;" onclick="shareGame()">’Ä’ê‘±’é‘ª’ê‘µ‘º</button>
                </div>
            </div>
        </div>

        <div class="nav-bar">
            <div id="nav-game" class="nav-item active" onclick="showTab('game')"><span>üéÆ</span><div>‘Ω‘±’Ç</div></div>
            <div id="nav-wheel" class="nav-item" onclick="showTab('wheel')"><span>üé°</span><div>‘±’Ü‘ª’é</div></div>
            <div id="nav-shop" class="nav-item" onclick="showTab('shop')"><span>üõí</span><div>VIP</div></div>
            <div id="nav-bonus" class="nav-item" onclick="showTab('bonus')"><span>üíé</span><div>‘≤’à’Ü’à’í’ç</div></div>
            <div id="nav-profile" class="nav-item" onclick="showTab('profile')"><span>üë§</span><div>‘µ’ç</div></div>
        </div>
    </div>

    <div id="modal" class="overlay">
        <h2 style="color: #e74c3c;">‘Ω‘±’Ç’Ü ‘±’é‘±’ê’è’é‘µ’ë</h2>
        <p style="color: #fff;">’Ñ’´’°’æ’∏÷Ä: <span id="end-score" style="font-weight: bold; color: var(--primary);">0</span></p>
        <button class="btn-main" onclick="closeModal()">‘ø’ê‘ø‘ª’Ü</button>
    </div>

    <script>
        // --- 1. SOUND SYSTEM (NO EXTERNAL FILES) ---
        const AudioSys = {
            ctx: null,
            muted: false,
            init: function() {
                if (!this.ctx) {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, duration) {
                if (this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            eat: function() { this.playTone(600, 'sine', 0.1); setTimeout(() => this.playTone(900, 'sine', 0.1), 50); },
            click: function() { this.playTone(300, 'triangle', 0.05); },
            die: function() { this.playTone(150, 'sawtooth', 0.5); },
            win: function() { 
                [400, 500, 600, 800].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.1), i*100));
            }
        };

        function toggleMute() {
            AudioSys.muted = !AudioSys.muted;
            document.getElementById('muteBtn').innerText = AudioSys.muted ? "üîá" : "üîä";
            if(!AudioSys.muted) AudioSys.init();
        }

        // --- 2. GAME LOGIC ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let box = 20, rows = 20, cols = 20;
        let snake=[], food={}, d, isRunning=false;
        let points = parseInt(localStorage.getItem('ht_balance')) || 0;
        let highScore = parseInt(localStorage.getItem('ht_highscore')) || 0;
        
        // Levels
        let level = parseInt(localStorage.getItem('game_level')) || 1;
        let levelProgress = 0;
        const LEVEL_GOAL = 40;
        const levelColors = ['#111', '#15202b', '#1a1010', '#101a1a'];

        let vipExpiry = parseInt(localStorage.getItem('vipExpiry')) || 0;
        let isVip = false;

        function resizeGame() {
            const container = document.querySelector('.canvas-container');
            const size = Math.min(container.clientWidth - 10, container.clientHeight - 10);
            box = Math.floor(size / 20); 
            canvas.width = box * 20; canvas.height = box * 20;
            document.getElementById('canvasWrapper').style.width = canvas.width + 'px'; 
            document.getElementById('canvasWrapper').style.height = canvas.height + 'px';
        }

        function initGame() {
            AudioSys.init();
            resizeGame();
            snake = [{x: 5*box, y: 10*box}, {x: 4*box, y: 10*box}, {x: 3*box, y: 10*box}];
            food = spawnItem(); 
            d = "RIGHT"; 
            levelProgress = 0;
            updateLevelUI();
            checkVip(); 
            updateUI(); 
            draw();
        }

        function spawnItem() { 
            return { x: Math.floor(Math.random() * cols) * box, y: Math.floor(Math.random() * rows) * box }; 
        }

        function startGame() { 
            document.getElementById('startOverlay').style.display = 'none'; 
            isRunning = true; 
            initGame(); 
            run(); 
        }

        function run() {
            if(!isRunning) return;
            
            let hx = snake[0].x, hy = snake[0].y;
            if(d=="LEFT") hx -= box; if(d=="UP") hy -= box;
            if(d=="RIGHT") hx += box; if(d=="DOWN") hy += box;

            if(hx < 0 || hx >= canvas.width || hy < 0 || hy >= canvas.height || snake.some(s => s.x === hx && s.y === hy)) { 
                endGame(); return; 
            }

            if(hx === food.x && hy === food.y) { 
                AudioSys.eat();
                if(window.navigator.vibrate) window.navigator.vibrate(50);
                let gain = isVip ? 2 : 1;
                points += gain; 
                levelProgress += 1;
                
                if(levelProgress >= LEVEL_GOAL) {
                    level++;
                    levelProgress = 0;
                    localStorage.setItem('game_level', level);
                    fireConfetti();
                    AudioSys.win();
                }

                food = spawnItem(); 
                updateLevelUI();
            } else { 
                snake.pop(); 
            }

            snake.unshift({x: hx, y: hy}); 
            draw(); 
            updateUI(); 
            
            let speed = Math.max(60, 160 - (level * 5));
            setTimeout(run, speed);
        }

        function draw() {
            let colorIndex = (level - 1) % levelColors.length;
            ctx.fillStyle = levelColors[colorIndex]; 
            ctx.fillRect(0,0,canvas.width,canvas.height);

            for(let i=0; i<snake.length; i++) {
                if(i == 0) { 
                    ctx.font = box + "px Arial"; 
                    ctx.fillText("üêç", snake[i].x, snake[i].y + box*0.8); 
                } else { 
                    ctx.fillStyle = isVip ? "#f1c40f" : "#2ecc71"; 
                    ctx.fillRect(snake[i].x+1, snake[i].y+1, box-2, box-2); 
                }
            }
            ctx.font = box + "px Arial"; 
            ctx.fillText("üçé", food.x, food.y + box*0.8);
        }

        function updateLevelUI() {
            document.getElementById('level-display').innerText = level;
            document.getElementById('overlay-level').innerText = level;
            document.getElementById('level-progress-text').innerText = levelProgress;
            let percent = (levelProgress / LEVEL_GOAL) * 100;
            document.getElementById('progress-fill').style.width = percent + '%';
        }

        function handleControl(e, dir) { 
            e.preventDefault(); 
            AudioSys.click();
            if(window.navigator.vibrate) window.navigator.vibrate(20);
            if(dir=="UP" && d!="DOWN") d="UP"; if(dir=="DOWN" && d!="UP") d="DOWN";
            if(dir=="LEFT" && d!="RIGHT") d="LEFT"; if(dir=="RIGHT" && d!="LEFT") d="RIGHT";
        }

        function endGame() { 
            isRunning = false; 
            AudioSys.die();
            if(window.navigator.vibrate) window.navigator.vibrate(300);
            if (points > highScore) {
                highScore = points;
                localStorage.setItem('ht_highscore', highScore);
            }
            document.getElementById('end-score').innerText = points;
            document.getElementById('modal').style.display = 'flex'; 
        }

        function closeModal() { 
            document.getElementById('modal').style.display = 'none'; 
            document.getElementById('startOverlay').style.display = 'flex'; 
        }

        // --- 3. WHEEL LOGIC (FIXED) ---
        // Mapping exactly to the visual CSS sectors. 
        // 0-45deg is Sector 1 (Top). Rotation is clockwise.
        // To land on Sector N, we need the wheel to stop such that Sector N is at the top pointer (0deg).
        // Angle = 360 - (SectorIndex * 45) - 22.5 (center offset)
        
        const wheelPrizes = [
            { label: "10 HT", val: 10, type: 'ht' },    // Index 0 (0-45 deg)
            { label: "25 HT", val: 25, type: 'ht' },    // Index 1 (45-90 deg)
            { label: "VIP 1’ï÷Ä", val: 0, type: 'vip' },  // Index 2 (90-135 deg)
            { label: "1 HT", val: 1, type: 'ht' },      // Index 3 (135-180 deg)
            { label: "0 HT", val: 0, type: 'ht' },      // Index 4 (180-225 deg)
            { label: "‘ø’ê‘ø‘ª’Ü", val: 0, type: 'again' },   // Index 5 (225-270 deg)
            { label: "1 ‚≠ê", val: 0, type: 'star' },    // Index 6 (270-315 deg)
            { label: "5 HT", val: 5, type: 'ht' }       // Index 7 (315-360 deg)
        ];

        let isSpinning = false;
        const SPIN_COOLDOWN = 4 * 60 * 60 * 1000; // 4 Hours in ms

        function spinWheel() {
            if(isSpinning) return;
            AudioSys.init();
            AudioSys.click();
            
            const lastSpin = parseInt(localStorage.getItem('lastWheelSpin')) || 0;
            const now = Date.now();
            if (now - lastSpin < SPIN_COOLDOWN) {
                alert("’ç’∫’°’Ω’•÷Ñ ’™’°’¥’°’∂’°’Ø’® ’¨÷Ä’°’∂’°!");
                return;
            }

            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('wheel-msg').innerText = "";

            // 1. Determine Prize Logic First
            // Weights: HT common, VIP/Star rare
            let rand = Math.random();
            let prizeIndex;

            if (rand < 0.2) prizeIndex = 4; // 20% 0 HT
            else if (rand < 0.35) prizeIndex = 3; // 15% 1 HT
            else if (rand < 0.50) prizeIndex = 7; // 15% 5 HT
            else if (rand < 0.60) prizeIndex = 0; // 10% 10 HT
            else if (rand < 0.75) prizeIndex = 5; // 15% Try Again
            else if (rand < 0.85) prizeIndex = 1; // 10% 25 HT
            else if (rand < 0.95) prizeIndex = 6; // 10% Star
            else prizeIndex = 2; // 5% VIP

            // Force a win for testing if you want (uncomment next line)
            // prizeIndex = 0; 

            // 2. Calculate Angle
            // Target is the center of the segment.
            // Segment 0 is at 22.5deg relative to start, but CSS rotates clockwise.
            // To bring Segment Index 0 to top (pointer), we rotate 360 - (0*45 + 22.5).
            const segmentArc = 45;
            const stopAngle = 360 - (prizeIndex * segmentArc + segmentArc/2);
            const extraSpins = 360 * 5; // 5 full spins
            const totalRotation = extraSpins + stopAngle;

            document.getElementById('wheel').style.transform = `rotate(${totalRotation}deg)`;

            // Sound effect while spinning (simple approximation)
            let ticks = 0;
            const tickInterval = setInterval(() => {
                if(ticks < 20) AudioSys.click();
                ticks++;
            }, 200);

            setTimeout(() => {
                clearInterval(tickInterval);
                finishSpin(prizeIndex, totalRotation);
            }, 4000);
        }

        function finishSpin(index, currentRotation) {
            isSpinning = false;
            const prize = wheelPrizes[index];
            let winMsg = "";
            let saveTime = true;

            if (prize.type === 'ht') {
                let amount = prize.val;
                if(isVip && amount > 0) amount *= 2;
                points += amount;
                winMsg = `‘¥’∏÷Ç÷Ñ ’∑’°’∞’•÷Å’´÷Ñ ${amount} HT!`;
                if(amount > 0) { AudioSys.win(); fireConfetti(); }
            } else if (prize.type === 'again') {
                winMsg = "’ä’ø’ø’•÷Ñ ’Ø÷Ä’Ø’´’∂ ’°’∂’æ’≥’°÷Ä!";
                saveTime = false; // Don't save time, allow respin
            } else if (prize.type === 'vip') {
                winMsg = "VIP 1 ’ï÷Ä ’°’Ø’ø’´’æ’°÷Å’°’æ!";
                buyVip(1, 0); // Activate VIP free
                fireConfetti();
                AudioSys.win();
            } else if (prize.type === 'star') {
                winMsg = "’á’°’∞’•÷Å’´÷Ñ 1 ‘±’Ω’ø’≤ (Beta)";
                AudioSys.win();
            }

            if (saveTime) {
                localStorage.setItem('lastWheelSpin', Date.now());
                document.getElementById('spinBtn').style.display = 'none';
                document.getElementById('wheel-timer').style.display = 'block';
                updateWheelTimer(); // Start timer immediately
            } else {
                 document.getElementById('spinBtn').disabled = false;
                 // Reset visuals for re-spin without animation glitch
                 document.getElementById('wheel').style.transition = 'none';
                 document.getElementById('wheel').style.transform = `rotate(${currentRotation % 360}deg)`;
                 setTimeout(() => { document.getElementById('wheel').style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.1, 1)'; }, 50);
            }

            document.getElementById('wheel-msg').innerText = winMsg;
            updateUI();
        }

        function updateWheelTimer() {
            const lastSpin = parseInt(localStorage.getItem('lastWheelSpin')) || 0;
            const now = Date.now();
            const diff = now - lastSpin;
            
            if (diff < SPIN_COOLDOWN) {
                const left = SPIN_COOLDOWN - diff;
                const h = Math.floor(left / (1000 * 60 * 60));
                const m = Math.floor((left % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((left % (1000 * 60)) / 1000);
                
                document.getElementById('wheel-timer').innerText = 
                    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                document.getElementById('spinBtn').style.display = 'none';
                document.getElementById('wheel-timer').style.display = 'block';
            } else {
                document.getElementById('spinBtn').style.display = 'block';
                document.getElementById('spinBtn').disabled = false;
                document.getElementById('wheel-timer').style.display = 'none';
            }
        }

        // --- 4. GENERAL FUNCTIONS ---

        function claimDailyBonus() {
            const today = new Date().toDateString();
            if(localStorage.getItem('lastDailyBonus') === today) return;
            
            points += isVip ? 50 : 25;
            localStorage.setItem('lastDailyBonus', today);
            fireConfetti();
            AudioSys.win();
            alert("‘≤’∏’∂’∏÷Ç’Ω’® ’Ω’ø’°÷Å’æ’°’Æ ’ß!");
            updateUI();
        }

        function checkVip() {
            isVip = Date.now() < vipExpiry;
            const vElem = document.getElementById('vip-status-profile');
            vElem.innerText = isVip ? "‚ú® VIP ‘±’Ø’ø’´’æ ’ß" : "’ç’∏’æ’∏÷Ä’°’Ø’°’∂ ’∞’°’∑’´’æ";
            vElem.style.color = isVip ? "#f1c40f" : "#888";
        }

        function buyVip(days, cost) {
            // Mock function
            vipExpiry = Date.now() + days*86400000; 
            localStorage.setItem('vipExpiry', vipExpiry); 
            checkVip(); updateUI(); 
        }
        
        function mockPurchase() { alert("‘≥’∂’¥’°’∂ ’∞’°’¥’°’Ø’°÷Ä’£’® ’¥’∑’°’Ø’¥’°’∂ ÷É’∏÷Ç’¨’∏÷Ç’¥ ’ß:"); }

        function withdrawMoney() {
            const limit = isVip ? 2500 : 5000;
            if(points >= limit) alert("’Ä’°’µ’ø’® ’®’∂’§’∏÷Ç’∂’æ’°’Æ ’ß!");
            else alert(`‘±’∂’¢’°’æ’°÷Ä’°÷Ä ’¥’´’ª’∏÷Å’∂’•÷Ä: ${limit} HT`);
        }

        function shareGame() {
            // ... (Your previous share logic)
            alert("Share link copied!");
        }

        function updateUI() {
            localStorage.setItem('ht_balance', points);
            document.getElementById('balance').innerText = points;
            document.getElementById('profile-balance').innerText = points;
            document.getElementById('high-score').innerText = highScore;
            document.getElementById('score').innerText = points; // Live score in game
            
            const limit = isVip ? 2500 : 5000;
            document.getElementById('withdraw-limit-text').innerText = limit;
            
            const dailyBtn = document.getElementById('claimBtn');
            const today = new Date().toDateString();
            if(localStorage.getItem('lastDailyBonus') === today) {
                dailyBtn.disabled = true;
                dailyBtn.innerText = "’é‘µ’ê‘±‘¥‘±’ê’Å‘ª’ê ’é‘±’Ç‘∏";
            } else {
                dailyBtn.disabled = false;
                dailyBtn.innerText = "‘≤‘±’ë‘µ‘º";
            }
        }

        function showTab(t) {
            document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
            document.getElementById(t+'-section').style.display = (t === 'game') ? 'flex' : 'block';
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('nav-'+t).classList.add('active');
            if(t === 'game') resizeGame();
        }

        // --- 5. EFFECTS (CONFETTI) ---
        const fxCanvas = document.getElementById('effectsCanvas');
        const fxCtx = fxCanvas.getContext('2d');
        let particles = [];

        function resizeFx() { fxCanvas.width = window.innerWidth; fxCanvas.height = window.innerHeight; }
        window.addEventListener('resize', () => { resizeGame(); resizeFx(); });

        function fireConfetti() {
            for(let i=0; i<50; i++) {
                particles.push({
                    x: window.innerWidth/2, y: window.innerHeight/2,
                    vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 1.0, color: `hsl(${Math.random()*360}, 100%, 50%)`
                });
            }
        }

        function updateFx() {
            fxCtx.clearRect(0,0,fxCanvas.width, fxCanvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                fxCtx.globalAlpha = p.life;
                fxCtx.fillStyle = p.color;
                fxCtx.beginPath(); fxCtx.arc(p.x, p.y, 4, 0, Math.PI*2); fxCtx.fill();
                if(p.life <= 0) particles.splice(i, 1);
            });
            requestAnimationFrame(updateFx);
        }
        resizeFx();
        updateFx();

        // --- INIT ---
        window.onload = () => { 
            if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.expand(); 
            initGame(); 
            showTab('game');
            setInterval(updateWheelTimer, 1000); // Check wheel timer every second
        };
    </script>
</body>
</html>
